<!DOCTYPE html>
<html>
  <head>
    <title>{{ title }}</title>
    <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.no-icons.min.css" rel="stylesheet">
    <link rel='stylesheet' href='/stylesheets/style.css' />
  </head>
  <body>
    <h1>{{ title }}</h1>
    <p>Welcome to {{ title }}</p>
    <form method="post">
        <div class="alert alert-info">
          <p>Securli is a simple service that stores encrypted messages for you,<br/>
            encrypted in by your browser.</p>
        </div>
        <p>Send a secure message</p>
        <div>
            <label for="to">recipient:</label>
            <div>
            </div>
            <textarea maxlength="140" id="msg" placeholder="Type your message here"></textarea>
            <input id="message" value="" type="hidden" name="message" />
            <div>
                <input class="btn" id="btn-encrypt" onclick="validate_form(); return false;" type="submit" value="encrypt" />
                <input class="btn" id="btn-send" type="submit" value="send messsage" disabled="disabled" />
            </div>
        </div>
    </form>

	<!-- Modal -->
	<div id="passwordModal" class="modal hide fade">
		<div class="modal-header">
			<h3>Please enter a secure password</h3>
		</div>
	  	<div class="modal-body">
			<div class="control-group">
				<label class="control-label" for="inputPassword">Password</label>
				<div class="controls">
					<div class="row-fluid">
						<div class="span6">
							<input type="password" id="inputPassword" placeholder="Password">
						</div>
						<div class="span6">
							<div class="progress">
								<div id="strengthBar" class="bar"></div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<em>hint: use a password that is long, and contains at least some spaces and numbers!</em>
		</div>
		<div class="modal-footer">
			<button id="btn-modal-cancel" class="btn" data-dismiss="modal">Cancel</button>
			<button id="btn-modal-encrypt" onclick="encrypt(); return false;" class="btn btn-primary">Encrypt</button>
		</div>
	</div>

    <script src="/javascripts/jquery-2.0.2.js"></script>
    <script src="/javascripts/sjcl.js"></script>
	<script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
    <script>

        function validate_form() {
            var $secret = $('#msg');
                
            if( ! /\w+\@\w+[.]\w+/.test($('#to').val() ) ){
              alert('Please provide a valid e-mail to send to!');
              return;
            }

            if( $secret.val().length > 140 ){
              alert('The message you typed is too long!');
              return;
            }

            if( $secret.val().length < 1 ){
              alert('The message you typed is too short!');
              return;
            }
			
			$("#passwordModal").modal("show");
			$("#inputPassword").val("");
			
        }

		function scorePassword(password){
			var score_length = 1,
				score_nonalpha = 0,
				score_repetitions = 0,
				score;

			// add a point for each character beyond the 5th
			if ( password.length >= 5 ) {
				score_length = password.length - 5;
			}

			// more points for containing non-alpha chars
			// (regex: spaces + restrict special characters)
			if ( /[^a-zA-Z0-9]/.test(password) ) {
				score_nonalpha = 1;
			}

			// no character is repeated more than twice
			// (regex: detect 2 or more + backref)
			if ( /(.)\1{2,}/.test(password) ) {
				score_repetitions = 1;
			}

			// The better if the password:
			// - is the longer (pref > 5)
			// - includes a non alpha char
			// - avoids char repetitions
			score = Math.log(score_length) * 25 +
					score_nonalpha         * 30 -
					score_repetitions      * 20 ;

			if ( password.length == 0) return 0;

			if ( score <= 0 ) return 10

			return score;
		}

		function encrypt() {
            var encrypted, password,
                $secret = $('#msg'),
				$input_pass = $("#inputPassword");
						
			password = $input_pass.val(),
            encrypted = sjcl.encrypt( password, $secret.val() );
			
            $secret.val( $secret.val().replace(/./g, '*' ) );
            
            $('#message').val(encrypted);
            $('#btn-encrypt').attr('disabled', true );
            $('#btn-send').removeAttr('disabled');
			$("#passwordModal").modal("hide");
		}

		// checks password strength on keyup
		$("#inputPassword").keyup(function(){
			var status = "",
				score = scorePassword($(this).val());

			$("#strengthBar").removeClass();

			if ( score >= 80 )
				status = "bar bar-success";

			if ( (score >= 40) && (score < 80) )
				status = "bar bar-warning";

			if ( score < 40 )
				status = "bar bar-danger";

			$("#strengthBar").addClass(status).css("width", score + "%");

			// console.log("Score (%s): %s ",$(this).val(),  score);
		});

    </script>
  </body>
</html>